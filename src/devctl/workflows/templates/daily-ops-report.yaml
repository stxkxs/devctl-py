# Daily Operations Report Workflow
#
# Morning operations report including:
# - AWS cost summary (last 24h)
# - Cost anomalies
# - Overnight PagerDuty incidents
# - Current Grafana alert status
# - Recent deployments
# - Summary posted to Slack
#
# Usage:
#   devctl workflow run daily-ops-report.yaml
#   devctl workflow run daily-ops-report.yaml --var slack_channel="#platform-ops"

name: daily-ops-report
description: Generate and post daily operations report to Slack

vars:
  # Optional variables with defaults
  slack_channel: "#ops"
  cost_days: 1
  cost_threshold: 1000
  incident_hours: 24

steps:
  - name: Get AWS cost summary
    command: aws cost summary
    params:
      days: "{{ cost_days }}"
    on_failure: continue

  - name: Check for cost anomalies
    command: aws cost anomalies
    params:
      days: "{{ cost_days }}"
    on_failure: continue

  - name: Find unused resources
    command: aws cost unused-resources
    on_failure: continue

  - name: Get overnight PagerDuty incidents
    command: pagerduty incidents list
    params:
      since: "{{ incident_hours }}h"
      status: "all"
    on_failure: continue

  - name: Get current Grafana alerts
    command: grafana alerts list
    params:
      state: "firing"
    on_failure: continue

  - name: Get recent deployments
    command: argocd apps list
    on_failure: continue

  - name: Post report header to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :sunrise: *Daily Ops Report - {{ '%Y-%m-%d' | strftime }}*

        ---
    on_failure: continue

  - name: Post cost summary to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :moneybag: *AWS Costs (Last 24h)*
        ```
        {{ results['Get AWS cost summary'].stdout | default('Cost data unavailable') | trim }}
        ```

        *Anomalies:* {{ results['Check for cost anomalies'].stdout | default('None detected') | trim }}
    on_failure: continue

  - name: Post incidents summary to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :rotating_light: *Incidents (Last {{ incident_hours }}h)*
        ```
        {{ results['Get overnight PagerDuty incidents'].stdout | default('No incidents') | trim }}
        ```
    on_failure: continue

  - name: Post alerts summary to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :warning: *Current Firing Alerts*
        ```
        {{ results['Get current Grafana alerts'].stdout | default('No firing alerts') | trim }}
        ```
    on_failure: continue

  - name: Post unused resources to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :recycle: *Unused Resources (Cost Optimization)*
        ```
        {{ results['Find unused resources'].stdout | default('No unused resources found') | trim }}
        ```

        ---
        _Report generated by devctl daily-ops-report workflow_
    on_failure: continue

  - name: Create Grafana annotation
    command: grafana annotations create
    params:
      text: "Daily ops report generated"
      tags: "ops-report,daily,automation"
    on_failure: continue
