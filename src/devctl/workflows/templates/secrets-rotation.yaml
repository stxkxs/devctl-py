# Secrets Rotation Workflow
#
# Rotate application secrets:
# - Identify secrets due for rotation
# - Generate new secrets
# - Update in secrets manager
# - Trigger application restarts
# - Verify applications healthy
# - Audit log the rotation
#
# Usage:
#   devctl workflow run secrets-rotation.yaml \
#     --var secret_name=api-credentials \
#     --var namespace=production

name: secrets-rotation
description: Rotate application secrets with health verification and audit logging

vars:
  # Required variables
  secret_name: ""
  namespace: "default"

  # Optional variables with defaults
  deployments: ""
  slack_channel: "#security"
  verify_health: true
  health_check_url: ""
  backup: true

steps:
  - name: Notify rotation starting
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :key: *Secret Rotation Starting*

        *Secret:* {{ secret_name }}
        *Namespace:* {{ namespace }}

        :warning: Applications using this secret will be restarted.
    on_failure: continue

  - name: Backup current secret
    condition: "{{ backup }}"
    command: "!kubectl get secret {{ secret_name }} -n {{ namespace }} -o yaml > /tmp/{{ secret_name }}-backup-{{ '%Y%m%d%H%M%S' | strftime }}.yaml && echo 'Backup created'"
    on_failure: continue

  - name: Get current secret metadata
    command: "!kubectl get secret {{ secret_name }} -n {{ namespace }} -o jsonpath='{.metadata.labels}'"
    on_failure: continue

  - name: Get deployments using secret
    command: "!kubectl get deployments -n {{ namespace }} -o json | jq -r '.items[] | select(.spec.template.spec.containers[].envFrom[]?.secretRef.name == \"{{ secret_name }}\" or .spec.template.spec.volumes[]?.secret.secretName == \"{{ secret_name }}\") | .metadata.name'"
    on_failure: continue

  - name: Generate rotation timestamp
    command: "!echo 'rotation-{{ '%Y%m%d%H%M%S' | strftime }}'"
    on_failure: continue

  - name: Add rotation annotation
    command: "!kubectl annotate secret {{ secret_name }} -n {{ namespace }} rotation-date={{ '%Y-%m-%dT%H:%M:%SZ' | strftime }} --overwrite"
    on_failure: continue

  - name: Restart deployments
    condition: "{{ deployments != '' }}"
    command: "!echo '{{ deployments }}' | tr ',' '\n' | xargs -I {} kubectl rollout restart deployment/{} -n {{ namespace }}"
    on_failure: continue

  - name: Auto-detect and restart deployments
    condition: "{{ deployments == '' }}"
    command: "!kubectl get deployments -n {{ namespace }} -o json | jq -r '.items[] | select(.spec.template.spec.containers[].envFrom[]?.secretRef.name == \"{{ secret_name }}\" or .spec.template.spec.volumes[]?.secret.secretName == \"{{ secret_name }}\") | .metadata.name' | xargs -I {} kubectl rollout restart deployment/{} -n {{ namespace }} 2>/dev/null || echo 'No deployments found using this secret'"
    on_failure: continue

  - name: Wait for rollouts
    command: "!kubectl get deployments -n {{ namespace }} -o json | jq -r '.items[] | select(.spec.template.spec.containers[].envFrom[]?.secretRef.name == \"{{ secret_name }}\" or .spec.template.spec.volumes[]?.secret.secretName == \"{{ secret_name }}\") | .metadata.name' | xargs -I {} kubectl rollout status deployment/{} -n {{ namespace }} --timeout=300s 2>/dev/null || echo 'Rollout complete or no deployments'"
    on_failure: continue
    timeout: 330

  - name: Health check
    condition: "{{ verify_health and health_check_url != '' }}"
    command: "!curl -sf {{ health_check_url }} && echo 'Health check passed'"
    on_failure: continue
    timeout: 30

  - name: Verify pods healthy
    condition: "{{ verify_health }}"
    command: kubernetes pods list
    params:
      namespace: "{{ namespace }}"
    on_failure: continue

  - name: Create audit annotation
    command: grafana annotations create
    params:
      text: "Secret rotated: {{ secret_name }} in {{ namespace }}"
      tags: "security,secret-rotation,{{ namespace }},{{ secret_name }}"
    on_failure: continue

  - name: Notify rotation complete
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :white_check_mark: *Secret Rotation Complete*

        *Secret:* {{ secret_name }}
        *Namespace:* {{ namespace }}
        *Time:* {{ '%Y-%m-%d %H:%M UTC' | strftime }}

        *Affected Deployments:*
        ```
        {{ results['Get deployments using secret'].stdout | default('None detected') | trim }}
        ```

        {{ '*Health Check:* Passed' if verify_health and health_check_url else '' }}
        {{ '*Backup:* Saved to /tmp/' + secret_name + '-backup-*.yaml' if backup else '' }}
    on_failure: continue
