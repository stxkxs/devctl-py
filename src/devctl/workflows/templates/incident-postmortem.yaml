# Incident Postmortem Workflow
#
# Post-incident documentation automation:
# - Create postmortem Confluence page
# - Extract timeline from Slack incident channel
# - Link related Jira tickets
# - Generate action items as Jira tasks
# - Notify stakeholders
#
# Usage:
#   devctl workflow run incident-postmortem.yaml \
#     --var incident_id=INC-123 \
#     --var slack_channel=incident-20241204-api

name: incident-postmortem
description: Create postmortem documentation with timeline, action items, and stakeholder notification

vars:
  # Required variables
  incident_id: ""
  slack_channel: ""
  title: ""

  # Optional variables with defaults
  confluence_space: "OPS"
  jira_project: "OPS"
  notify_channel: "#incidents"
  severity: "p2"
  duration_minutes: ""
  root_cause: ""
  resolution: ""

steps:
  - name: Notify postmortem starting
    command: slack send
    params:
      channel: "{{ notify_channel }}"
      message: |
        :memo: *Postmortem Started*

        Creating postmortem documentation for incident {{ incident_id }}
    on_failure: continue

  - name: Get incident details from PagerDuty
    command: pagerduty incidents get
    params:
      id: "{{ incident_id }}"
    on_failure: continue

  - name: Get related Jira tickets
    command: jira issues search
    params:
      jql: "labels = {{ incident_id }} OR text ~ '{{ incident_id }}'"
      max: 20
    on_failure: continue

  - name: Create postmortem Confluence page
    command: confluence pages create
    params:
      space: "{{ confluence_space }}"
      title: "Postmortem: {{ title }} ({{ incident_id }})"
      content: |
        h1. Incident Postmortem: {{ title }}

        || Property || Value ||
        | Incident ID | {{ incident_id }} |
        | Severity | {{ severity | upper }} |
        | Duration | {{ duration_minutes | default('TBD') }} minutes |
        | Date | {{ '%Y-%m-%d' | strftime }} |
        | Slack Channel | #{{ slack_channel }} |

        h2. Summary

        _Brief description of what happened and impact._

        h2. Timeline

        _Key events during the incident. Extract from #{{ slack_channel }}._

        | Time | Event |
        | | Incident detected |
        | | Response initiated |
        | | Root cause identified |
        | | Mitigation applied |
        | | Incident resolved |

        h2. Root Cause

        {{ root_cause | default('_To be determined during postmortem review._') }}

        h2. Resolution

        {{ resolution | default('_Document how the incident was resolved._') }}

        h2. Impact

        _Describe customer and business impact._

        * Services affected:
        * Users affected:
        * Revenue impact:

        h2. What Went Well

        *
        *

        h2. What Could Be Improved

        *
        *

        h2. Action Items

        _Action items will be created as Jira tickets and linked below._

        h2. Related Tickets

        {noformat}
        {{ results['Get related Jira tickets'].stdout | default('No related tickets found') | trim }}
        {noformat}

        ----
        _Generated by devctl incident-postmortem workflow_
    on_failure: continue

  - name: Create action item - Improve monitoring
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Task"
      summary: "[Postmortem] {{ incident_id }} - Improve monitoring/alerting"
      description: |
        Action item from postmortem for {{ incident_id }}: {{ title }}

        Review and improve monitoring and alerting to detect this issue faster.

        See postmortem: {{ confluence_space }}
      labels: "postmortem,{{ incident_id }},action-item"
    on_failure: continue

  - name: Create action item - Prevent recurrence
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Task"
      summary: "[Postmortem] {{ incident_id }} - Prevent recurrence"
      description: |
        Action item from postmortem for {{ incident_id }}: {{ title }}

        Implement changes to prevent this incident from recurring.

        See postmortem: {{ confluence_space }}
      labels: "postmortem,{{ incident_id }},action-item"
    on_failure: continue

  - name: Post to incident channel
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :memo: *Postmortem Created*

        The postmortem document has been created in Confluence ({{ confluence_space }}).

        Action items have been created in Jira ({{ jira_project }}).

        Please review and add your observations.
    on_failure: continue

  - name: Notify stakeholders
    command: slack send
    params:
      channel: "{{ notify_channel }}"
      message: |
        :white_check_mark: *Postmortem Complete*

        *Incident:* {{ incident_id }} - {{ title }}
        *Severity:* {{ severity | upper }}
        *Documentation:* Confluence ({{ confluence_space }})

        Action items created in {{ jira_project }}.
    on_failure: continue

  - name: Create Grafana annotation
    command: grafana annotations create
    params:
      text: "Postmortem created for {{ incident_id }}"
      tags: "postmortem,{{ incident_id }},{{ severity }}"
    on_failure: continue
