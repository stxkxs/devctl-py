# Quarterly Access Review Workflow
#
# Automated IAM access review for compliance:
# - Run IAM access review (inactive users)
# - Check for overly permissive policies
# - Generate compliance report
# - Create Jira tickets for remediation
# - Publish report to Confluence
# - Notify security team
#
# Usage:
#   devctl workflow run access-review-quarterly.yaml
#   devctl workflow run access-review-quarterly.yaml --var inactive_days=60

name: access-review-quarterly
description: Quarterly IAM access review with compliance reporting and remediation tracking

vars:
  # Optional variables with defaults
  inactive_days: 90
  jira_project: "SEC"
  confluence_space: "SECURITY"
  slack_channel: "#security"
  create_tickets: true

steps:
  - name: Notify review starting
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :shield: *Quarterly Access Review Starting*

        Running automated IAM access review...
        - Inactive threshold: {{ inactive_days }} days
        - Report will be published to Confluence
    on_failure: continue

  - name: Run IAM access review
    command: compliance access-review
    params:
      days: "{{ inactive_days }}"
    on_failure: continue

  - name: Get inactive users list
    command: aws iam list-users
    params:
      inactive-days: "{{ inactive_days }}"
    on_failure: continue

  - name: Check overly permissive policies
    command: compliance pci scan
    params:
      controls: "iam"
    on_failure: continue

  - name: Get IAM credential report
    command: "!aws iam generate-credential-report && sleep 5 && aws iam get-credential-report --query 'Content' --output text | base64 -d"
    on_failure: continue
    timeout: 60

  - name: List unused access keys
    command: aws iam access-keys
    params:
      unused-days: "{{ inactive_days }}"
    on_failure: continue

  - name: Check for admin users
    command: "!aws iam list-users --query 'Users[*].UserName' --output text | xargs -I {} aws iam list-attached-user-policies --user-name {} --query 'AttachedPolicies[?PolicyName==`AdministratorAccess`]'"
    on_failure: continue

  - name: Create Confluence report
    command: confluence pages create
    params:
      space: "{{ confluence_space }}"
      title: "IAM Access Review - {{ '%Y Q' | strftime }}{{ (('%m' | strftime | int) - 1) // 3 + 1 }}"
      content: |
        h1. Quarterly IAM Access Review

        *Review Date:* {{ '%Y-%m-%d' | strftime }}
        *Inactive Threshold:* {{ inactive_days }} days

        h2. Summary

        This automated review identifies:
        * Inactive user accounts
        * Unused access keys
        * Overly permissive policies
        * Users with admin access

        h2. Inactive Users

        {noformat}
        {{ results['Run IAM access review'].stdout | default('No data available') | trim }}
        {noformat}

        h2. Unused Access Keys

        {noformat}
        {{ results['List unused access keys'].stdout | default('No unused keys found') | trim }}
        {noformat}

        h2. Policy Compliance

        {noformat}
        {{ results['Check overly permissive policies'].stdout | default('Scan results unavailable') | trim }}
        {noformat}

        h2. Required Actions

        * Review and disable inactive accounts
        * Rotate or delete unused access keys
        * Review admin access grants
        * Update policies to least privilege

        ----
        _Generated by devctl access-review-quarterly workflow_
    on_failure: continue

  - name: Create Jira epic for remediation
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Epic"
      summary: "[Access Review] Q{{ (('%m' | strftime | int) - 1) // 3 + 1 }} {{ '%Y' | strftime }} IAM Remediation"
      description: |
        Quarterly IAM access review remediation tasks.

        *Review Date:* {{ '%Y-%m-%d' | strftime }}
        *Inactive Threshold:* {{ inactive_days }} days

        h3. Findings Summary

        {noformat}
        {{ results['Run IAM access review'].stdout | default('See Confluence report') | trim }}
        {noformat}

        h3. Required Actions

        # Review and disable inactive user accounts
        # Rotate or delete unused access keys ({{ inactive_days }}+ days)
        # Review users with AdministratorAccess policy
        # Update overly permissive IAM policies

        See full report in Confluence: {{ confluence_space }}
      priority: "High"
      labels: "security,access-review,quarterly,compliance"
    on_failure: continue

  - name: Create ticket for inactive users
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Task"
      summary: "[Access Review] Disable inactive IAM users"
      description: |
        Review and disable IAM users inactive for {{ inactive_days }}+ days.

        h3. Inactive Users

        {noformat}
        {{ results['Get inactive users list'].stdout | default('See access review report') | trim }}
        {noformat}

        h3. Actions

        # Verify each user is no longer needed
        # Disable console access
        # Delete or deactivate access keys
        # Document in access review tracker
      priority: "High"
      labels: "security,access-review,iam"
    on_failure: continue

  - name: Create ticket for unused access keys
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Task"
      summary: "[Access Review] Rotate unused access keys"
      description: |
        Rotate or delete access keys unused for {{ inactive_days }}+ days.

        h3. Unused Keys

        {noformat}
        {{ results['List unused access keys'].stdout | default('See access review report') | trim }}
        {noformat}

        h3. Actions

        # Contact key owners to verify if still needed
        # Deactivate unused keys
        # Delete keys after 30-day deactivation period
        # Update applications if keys are rotated
      priority: "Medium"
      labels: "security,access-review,access-keys"
    on_failure: continue

  - name: Create Grafana annotation
    command: grafana annotations create
    params:
      text: "Quarterly IAM access review completed"
      tags: "security,access-review,compliance,quarterly"
    on_failure: continue

  - name: Post summary to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :white_check_mark: *Quarterly Access Review Complete*

        *Inactive Threshold:* {{ inactive_days }} days

        :page_facing_up: *Report:* Published to Confluence ({{ confluence_space }})
        :ticket: *Tickets:* Created in {{ jira_project }}

        *Summary:*
        ```
        {{ results['Run IAM access review'].stdout | default('Review completed - see Confluence for details') | trim }}
        ```

        Please review findings and complete remediation tasks.
    on_failure: continue
