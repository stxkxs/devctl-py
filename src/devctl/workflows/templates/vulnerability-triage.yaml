# Vulnerability Triage Workflow
#
# Triage security vulnerabilities:
# - Get new vulnerabilities from ECR scans
# - Prioritize by CVSS score
# - Check if patches available
# - Create Jira tickets by severity
# - Assign to appropriate teams
# - Post summary to security channel
#
# Usage:
#   devctl workflow run vulnerability-triage.yaml \
#     --var ecr_repos=api,worker

name: vulnerability-triage
description: Triage vulnerabilities from ECR scans with Jira ticket creation

vars:
  # Required variables
  ecr_repos: ""

  # Optional variables with defaults
  min_severity: "HIGH"
  jira_project: "SEC"
  slack_channel: "#security"
  create_tickets: true

steps:
  - name: Notify triage starting
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :mag: *Vulnerability Triage Starting*

        *Repositories:* {{ ecr_repos }}
        *Min Severity:* {{ min_severity }}
    on_failure: continue

  - name: Get critical vulnerabilities
    command: "!echo '{{ ecr_repos }}' | tr ',' '\n' | while read repo; do echo \"=== $repo ===\"; aws ecr describe-image-scan-findings --repository-name $repo --image-id imageTag=latest --query 'imageScanFindings.findings[?severity==`CRITICAL`].[name,description]' --output table 2>/dev/null || echo 'No scan results'; done"
    on_failure: continue

  - name: Get high severity vulnerabilities
    command: "!echo '{{ ecr_repos }}' | tr ',' '\n' | while read repo; do echo \"=== $repo ===\"; aws ecr describe-image-scan-findings --repository-name $repo --image-id imageTag=latest --query 'imageScanFindings.findings[?severity==`HIGH`].[name,description]' --output table 2>/dev/null || echo 'No scan results'; done"
    on_failure: continue

  - name: Get vulnerability counts
    command: "!echo '{{ ecr_repos }}' | tr ',' '\n' | while read repo; do echo -n \"$repo: \"; aws ecr describe-image-scan-findings --repository-name $repo --image-id imageTag=latest --query 'imageScanFindings.findingSeverityCounts' --output json 2>/dev/null || echo '{}'; done"
    on_failure: continue

  - name: Check for available patches
    command: "!echo 'Checking patch availability for detected vulnerabilities...'"
    on_failure: continue

  - name: Create critical vulnerability ticket
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Bug"
      summary: "[CRITICAL] {{ '%Y-%m-%d' | strftime }} ECR vulnerability triage"
      description: |
        Critical vulnerabilities detected in ECR image scans.

        *Repositories:* {{ ecr_repos }}
        *Scan Date:* {{ '%Y-%m-%d' | strftime }}

        h3. Critical Vulnerabilities
        {noformat}
        {{ results['Get critical vulnerabilities'].stdout | default('None found') | trim }}
        {noformat}

        h3. Vulnerability Counts
        {noformat}
        {{ results['Get vulnerability counts'].stdout | default('Counts unavailable') | trim }}
        {noformat}

        h3. Required Actions
        * Update base images to latest patched versions
        * Update vulnerable dependencies
        * Rebuild and redeploy affected images
        * Verify fixes with new scan

        *SLA:* Critical vulnerabilities must be remediated within 7 days
      priority: "Highest"
      labels: "security,vulnerability,critical,ecr"
    on_failure: continue

  - name: Create high severity ticket
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Bug"
      summary: "[HIGH] {{ '%Y-%m-%d' | strftime }} ECR vulnerability triage"
      description: |
        High severity vulnerabilities detected in ECR image scans.

        *Repositories:* {{ ecr_repos }}
        *Scan Date:* {{ '%Y-%m-%d' | strftime }}

        h3. High Severity Vulnerabilities
        {noformat}
        {{ results['Get high severity vulnerabilities'].stdout | default('None found') | trim }}
        {noformat}

        h3. Required Actions
        * Review and prioritize remediation
        * Update affected dependencies
        * Schedule rebuild for affected images

        *SLA:* High severity vulnerabilities must be remediated within 30 days
      priority: "High"
      labels: "security,vulnerability,high,ecr"
    on_failure: continue

  - name: Create Grafana annotation
    command: grafana annotations create
    params:
      text: "Vulnerability triage completed for {{ ecr_repos }}"
      tags: "security,vulnerability,triage"
    on_failure: continue

  - name: Post triage summary
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :white_check_mark: *Vulnerability Triage Complete*

        *Repositories:* {{ ecr_repos }}

        :red_circle: *Critical*
        ```
        {{ results['Get critical vulnerabilities'].stdout | default('None found') | trim }}
        ```

        :orange_circle: *High*
        ```
        {{ results['Get high severity vulnerabilities'].stdout | default('None found') | trim }}
        ```

        :bar_chart: *Counts by Severity*
        ```
        {{ results['Get vulnerability counts'].stdout | default('Unavailable') | trim }}
        ```

        {{ 'Tickets created in ' + jira_project if create_tickets else 'Run with --var create_tickets=true to create tickets' }}
    on_failure: continue
