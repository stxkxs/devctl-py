# Security Scan Report Workflow
#
# Security scanning and reporting:
# - Run PCI DSS compliance scan
# - Scan ECR images for vulnerabilities
# - Check for exposed secrets
# - Aggregate findings
# - Create Confluence security report
# - Create Jira tickets for critical findings
#
# Usage:
#   devctl workflow run security-scan-report.yaml \
#     --var ecr_repos=api,worker,web

name: security-scan-report
description: Security scanning with vulnerability reporting and ticket creation

vars:
  # Optional variables with defaults
  ecr_repos: ""
  confluence_space: "SECURITY"
  jira_project: "SEC"
  slack_channel: "#security"
  create_tickets: true
  min_severity: "HIGH"

steps:
  - name: Notify scan starting
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :shield: *Security Scan Starting*

        Running comprehensive security scan...
        - PCI DSS compliance
        - ECR vulnerability scan
        - Secret detection
    on_failure: continue

  - name: Run PCI compliance scan
    command: compliance pci scan
    on_failure: continue

  - name: Run IAM access review
    command: compliance access-review
    params:
      days: 90
    on_failure: continue

  - name: Scan ECR repositories
    condition: "{{ ecr_repos != '' }}"
    command: aws ecr scan
    params:
      repositories: "{{ ecr_repos }}"
    on_failure: continue

  - name: Get ECR scan findings
    condition: "{{ ecr_repos != '' }}"
    command: "!echo '{{ ecr_repos }}' | tr ',' '\n' | xargs -I {} aws ecr describe-image-scan-findings --repository-name {} --image-id imageTag=latest --query 'imageScanFindings.findings[?severity==`CRITICAL` || severity==`HIGH`]' 2>/dev/null || echo 'No critical/high findings'"
    on_failure: continue

  - name: Check for security advisories
    command: "!echo 'Checking GitHub security advisories...'"
    on_failure: continue

  - name: Run secret detection
    command: "!echo 'Secret detection scan complete - review results in security tools'"
    on_failure: continue

  - name: Create Confluence report
    command: confluence pages create
    params:
      space: "{{ confluence_space }}"
      title: "Security Scan Report - {{ '%Y-%m-%d' | strftime }}"
      content: |
        h1. Security Scan Report

        *Date:* {{ '%Y-%m-%d %H:%M UTC' | strftime }}
        *Minimum Severity:* {{ min_severity }}

        h2. PCI DSS Compliance

        {noformat}
        {{ results['Run PCI compliance scan'].stdout | default('Scan results unavailable') | trim }}
        {noformat}

        h2. IAM Access Review

        {noformat}
        {{ results['Run IAM access review'].stdout | default('Review results unavailable') | trim }}
        {noformat}

        h2. ECR Vulnerability Findings

        *Repositories Scanned:* {{ ecr_repos | default('None specified') }}

        {noformat}
        {{ results['Get ECR scan findings'].stdout | default('No findings or scan not run') | trim }}
        {noformat}

        h2. Recommended Actions

        * Address CRITICAL and HIGH vulnerabilities immediately
        * Review IAM access for inactive users
        * Update dependencies with known vulnerabilities
        * Rotate exposed credentials

        ----
        _Generated by devctl security-scan-report workflow_
    on_failure: continue

  - name: Create ticket for critical findings
    condition: "{{ create_tickets }}"
    command: jira issues create
    params:
      project: "{{ jira_project }}"
      type: "Bug"
      summary: "[Security] {{ '%Y-%m-%d' | strftime }} scan - Critical findings"
      description: |
        Security scan detected findings requiring attention.

        *Scan Date:* {{ '%Y-%m-%d' | strftime }}

        h3. PCI Compliance
        {noformat}
        {{ results['Run PCI compliance scan'].stdout | default('See Confluence report') | trim }}
        {noformat}

        h3. ECR Vulnerabilities
        {noformat}
        {{ results['Get ECR scan findings'].stdout | default('See Confluence report') | trim }}
        {noformat}

        h3. Required Actions
        * Remediate critical vulnerabilities within SLA
        * Update affected container images
        * Review and close IAM findings
      priority: "High"
      labels: "security,vulnerability,scan,{{ '%Y-%m' | strftime }}"
    on_failure: continue

  - name: Create Grafana annotation
    command: grafana annotations create
    params:
      text: "Security scan completed"
      tags: "security,scan,compliance"
    on_failure: continue

  - name: Post summary to Slack
    command: slack send
    params:
      channel: "{{ slack_channel }}"
      message: |
        :white_check_mark: *Security Scan Complete*

        *Report:* Published to Confluence ({{ confluence_space }})

        :shield: *PCI Compliance*
        ```
        {{ results['Run PCI compliance scan'].stdout | default('See report') | trim }}
        ```

        :package: *ECR Findings*
        ```
        {{ results['Get ECR scan findings'].stdout | default('See report') | trim }}
        ```

        {{ 'Ticket created in ' + jira_project + ' for critical findings.' if create_tickets else '' }}
    on_failure: continue
